# 验证码检测与用户等待机制 - Brownfield Addition

## 用户故事

**作为一名** 使用批量注册工具的用户,  
**我想要** 系统能够自动检测验证码并优雅地等待我手动处理,  
**以便于** 我在遇到验证码时不会丢失注册进度，且能够无缝继续批量处理流程。

## 故事上下文

**现有系统集成：**
- 集成对象: AutomationService 的账户注册工作流
- 技术栈: Playwright 自动化框架 + PySide6 状态管理
- 遵循模式: 现有的回调驱动状态更新模式
- 接触点: 注册流程第5步，AccountStatus 状态枚举，UI状态更新机制

## 验收标准

**功能性需求：**
1. 系统能够在注册过程中检测到验证码弹窗的出现
2. 检测到验证码时，账户状态更新为"验证码识别中"
3. 系统以1秒间隔轮询验证码是否仍然存在，而不阻塞其他操作

**集成需求：**
4. 现有的注册成功检测逻辑（检查"已登录"状态）继续正常工作
5. 验证码处理遵循现有的AccountStatus状态管理模式  
6. UI更新通过现有的信号槽机制保持响应性，不使用弹出框强提示

**质量需求：**
7. 验证码等待过程不会阻塞GUI主线程
8. 轮询机制有合理的超时处理，防止无限等待
9. 现有注册流程的其他步骤不受影响

## 技术说明

- **集成方法:** 在现有注册流程第5步中插入验证码检测分支
- **现有模式参考:** 参考当前AutomationService的状态回调模式
- **关键约束:** 必须使用"弱提示"而非阻塞式弹窗，保持UI响应性

## 完成定义

- [ ] 验证码检测逻辑已实现并集成到注册流程
- [ ] AccountStatus 枚举包含"验证码识别中"状态  
- [ ] 1秒轮询机制正常工作且不阻塞UI
- [ ] 现有注册流程功能验证无回归
- [ ] 状态更新通过现有信号槽正确传递到UI
- [ ] 代码遵循现有MVVM架构模式

## 风险和兼容性检查

**最小风险评估:**
- **主要风险:** 轮询机制可能影响系统性能或造成资源泄漏
- **缓解措施:** 实现合理的超时机制和资源清理逻辑
- **回滚方案:** 可以通过移除检测分支恢复到原有直接注册流程

**兼容性验证:**
- [x] 对现有AutomationService APIs无破坏性更改
- [x] AccountStatus枚举扩展仅为添加性质  
- [x] UI更改遵循现有信号槽更新模式
- [x] 性能影响可忽略（1秒轮询间隔）

## 相关技术细节

### 注册流程集成点（来自PRD docs/prd.md#L250-259）

```
5. 点击注册按钮
  5.1 等待几秒后验证当前为"已登录"状态，则代表注册成功
  5.2 如果弹出了验证码，则状态为"验证码识别中"，并提示用户操作（不使用弹出框等强提示，应该使用弱提示）
  5.3 每隔一秒检测是否还有验证码的弹窗，有则继续等待1秒并重新检测，没有则检测是否是"已登录"状态
6. 流程结束
```

---

**故事状态:** ✅ 已验证完成，准备开发  
**创建日期:** 2025-01-01  
**预估工作量:** 2-4小时专注开发会话