# Story 1.3: 创建基础的命令行接口 (CLI)

## Status
Approved

## Story
**作为一名** 开发者,
**我想要** 一个简单的命令行接口，让我可以传入用户名和密码来调用注册逻辑并看到结果,
**以便于** 我能在没有完整GUI的情况下，方便地测试和演示核心引擎的功能。

## Acceptance Criteria
1. 可以通过命令行运行脚本（例如 `python main.py --username test --password pass`）。
2. CLI能正确调用故事1.2中实现的注册逻辑。
3. 注册成功时，命令行输出"Success"或类似成功信息。
4. 注册失败时，命令行输出"Error"或相关失败信息。

## Tasks / Subtasks
- [ ] Task 1: Create CLI argument parser for username and password inputs (AC: 1)
  - [ ] Add argparse module to handle command line arguments
  - [ ] Define --username and --password arguments with proper validation
  - [ ] Add help text and argument descriptions
  - [ ] Handle missing required arguments with appropriate error messages

- [ ] Task 2: Create CLI entry point and integrate with existing AutomationService (AC: 1, 2)
  - [ ] Create `src/cli.py` module for CLI functionality following project structure
  - [ ] Import and utilize existing `AutomationService` from `src/services/automation_service.py`
  - [ ] Create Account objects using the existing `Account` model from `src/models/account.py`
  - [ ] Implement CLI-specific callback handlers for automation service events

- [ ] Task 3: Implement CLI output formatting for success and failure cases (AC: 3, 4)
  - [ ] Handle successful registration with clear "Success" message
  - [ ] Handle failed registration with "Error" message and specific failure reason
  - [ ] Use existing translation system (tr function) for consistent messaging
  - [ ] Format output appropriately for command line consumption

- [ ] Task 4: Modify main.py to support CLI mode (AC: 1)
  - [ ] Detect command line arguments to choose between GUI and CLI mode
  - [ ] Route to CLI functionality when CLI arguments are present
  - [ ] Maintain backward compatibility with existing GUI startup
  - [ ] Handle CLI mode execution with proper error handling

- [ ] Task 5: Add unit tests for CLI functionality
  - [ ] Create test file `tests/unit/test_cli.py` following testing strategy
  - [ ] Test argument parsing with valid and invalid inputs
  - [ ] Mock AutomationService for isolated CLI testing
  - [ ] Test success and failure output formatting

## Dev Notes

### Previous Story Insights
Key learnings from Story 1.2:
- AutomationService successfully implemented with Playwright integration
- Account model has proper status tracking (QUEUED, PROCESSING, SUCCESS, FAILED)
- Translation system (tr function) is working correctly for internationalization
- Comprehensive error handling implemented with detailed error messages
- Browser automation working with proper resource cleanup

### Technical Stack Requirements
[Source: docs/architecture/tech-stack.md]
- **Language**: Python 3.12
- **Architecture**: MVVM pattern with Service layer abstraction
- **Testing**: pytest for unit testing
- **CLI Library**: Use Python standard library argparse for command line parsing

### Project Structure Alignment
[Source: docs/architecture/source-tree.md]
- CLI module should be created at: `src/cli.py` (service layer functionality)
- Main entry point: `main.py` (already exists, needs modification)
- Test files: `tests/unit/test_cli.py`

### Data Models
[Source: src/models/account.py - existing implementation]
- **Account**: dataclass with id, username, password, status, notes
- **AccountStatus**: Enum with QUEUED, PROCESSING, SUCCESS, FAILED states
- Account validation: username and password required, password min 6 characters
- Status methods: mark_processing(), mark_success(), mark_failed(), reset_status()

### Service Integration
[Source: src/services/automation_service.py - Story 1.2 implementation]
- **AutomationService**: Already implemented with callback-based architecture
- **register_single_account()**: Async method accepting Account object
- **Callback system**: on_account_start, on_account_complete, on_log_message
- **Browser management**: Automatic Playwright initialization and cleanup
- **Error handling**: Comprehensive exception handling with detailed error messages

### CLI Requirements
- Use argparse for command line argument parsing
- Support --username and --password arguments as required parameters
- Integrate with existing AutomationService callback system
- Handle async operations properly in CLI context
- Use existing translation system (tr function) for consistent messaging
- Follow MVVM architecture by keeping business logic in service layer

### Testing Requirements
[Source: docs/architecture/test-strategy.md]
- **Unit Testing**: Service layer business logic testing with pytest
- **Test Location**: `tests/unit/test_cli.py`
- **Mock Strategy**: Mock AutomationService for isolated testing
- **Coverage**: Argument parsing, success/failure output formatting, error handling

### Technical Constraints
- Must use existing Account and AutomationService implementations
- Maintain compatibility with existing MVVM architecture
- Support internationalization through tr() function
- Handle async operations properly in synchronous CLI context
- Follow existing error handling patterns from Story 1.2

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-31 | 1.0 | Initial story creation based on Epic 1.3 requirements | Scrum Master Bob |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

## QA Results
*This section will be populated by the QA agent during review*