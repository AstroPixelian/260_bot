# Story 3.2: 智能验证码检测与用户协助系统

## Status
Ready for Development

## Story
**作为一个** 使用批量账户注册工具的用户,
**我想要** 系统能够智能检测验证码并提供渐进式的处理协助，从友好等待到主动协助,
**以便于** 在遇到验证码时不会丢失注册进度，且能根据需要选择最适合的处理方式。

## Product Strategy - 分阶段实现

### Phase 1: 智能等待机制 (MVP - 立即交付价值)
**目标**: 确保用户永不因验证码而丢失注册进度
**时间**: 2-4小时开发会话
**用户价值**: 友好的验证码检测 + 弱提示 + 状态管理

### Phase 2: 主动协助机制 (增强 - 提升用户体验)  
**目标**: 主动协助用户处理验证码，提供图片显示和输入界面
**时间**: 1-2个开发会话
**用户价值**: 验证码图片显示 + 用户输入界面 + 智能重试

## Acceptance Criteria

### Phase 1 验收标准 (MVP)
1. 系统能在注册流程中自动检测验证码弹窗的存在
2. 检测到验证码时，账户状态更新为"验证码等待中"，显示友好提示
3. 系统以1秒间隔智能轮询验证码是否消失，不阻塞其他操作
4. 轮询包含合理的超时处理机制（60秒），防止无限等待
5. 验证码处理完成后，系统能自动恢复并完成注册流程

### Phase 2 验收标准 (增强)
6. 验证码图片能在GUI弹窗中清晰显示给用户
7. 提供用户友好的验证码输入界面，支持文本输入
8. 支持验证码刷新功能，失败时最多自动重试3次
9. 验证码处理界面支持多语言切换（中文/英文）
10. 支持常见验证码类型：文本验证码、数学验证码

## Tasks / Subtasks

### Phase 1 Tasks (MVP Implementation)
- [ ] Task 1: 扩展AccountStatus枚举 (AC: 2)
  - [ ] 添加CAPTCHA_PENDING状态到AccountStatus
  - [ ] 更新状态翻译和显示逻辑
  - [ ] 测试状态在UI中的正确显示

- [ ] Task 2: 创建基础CaptchaService (AC: 1, 3)
  - [ ] 实现验证码元素检测逻辑（基础版）
  - [ ] 创建轮询检测机制（1秒间隔）
  - [ ] 实现超时处理（60秒）
  - [ ] 集成现有异常处理框架

- [ ] Task 3: 集成AutomationService (AC: 1, 4, 5)
  - [ ] 在注册流程中添加验证码检测分支
  - [ ] 实现验证码等待状态回调
  - [ ] 保持现有MVVM架构和信号槽机制
  - [ ] 测试与现有注册流程的兼容性

- [ ] Task 4: GUI状态更新集成 (AC: 2, 3)
  - [ ] 更新UI显示CAPTCHA_PENDING状态
  - [ ] 实现友好的验证码等待提示
  - [ ] 确保轮询不阻塞GUI主线程
  - [ ] 集成多语言支持

- [ ] Task 5: Phase 1 综合测试 (AC: 1-5)
  - [ ] 单元测试：验证码检测逻辑
  - [ ] 集成测试：完整注册流程
  - [ ] 性能测试：轮询机制影响
  - [ ] 用户体验测试：友好提示效果

### Phase 2 Tasks (Enhancement Implementation)
- [ ] Task 6: CaptchaDialog GUI组件 (AC: 6, 7)
  - [ ] 创建模态验证码显示对话框
  - [ ] 实现验证码图片显示功能
  - [ ] 添加用户输入界面元素
  - [ ] 集成PySide6 QDialog架构

- [ ] Task 7: 增强CaptchaService功能 (AC: 8, 10)
  - [ ] 实现验证码图片截取功能
  - [ ] 添加验证码刷新逻辑
  - [ ] 实现智能重试机制（最多3次）
  - [ ] 支持多种验证码类型识别

- [ ] Task 8: 用户交互流程 (AC: 6, 7, 9)
  - [ ] 实现用户输入处理逻辑
  - [ ] 添加确认/取消/刷新按钮
  - [ ] 集成多语言界面支持
  - [ ] 实现模态对话框生命周期管理

- [ ] Task 9: Phase 2 综合测试 (AC: 6-10)
  - [ ] GUI测试：对话框交互
  - [ ] 集成测试：完整用户流程
  - [ ] 多语言测试：界面切换
  - [ ] 异常测试：各种验证码类型

## Dev Notes

### Architecture Integration
**MVVM合规性**: 两个Phase都严格遵循现有MVVM架构模式
- **Model**: 扩展AccountStatus，新增Captcha数据模型
- **View**: Phase 1使用现有UI，Phase 2添加CaptchaDialog
- **ViewModel**: 通过现有信号槽机制协调验证码处理
- **Service**: CaptchaService作为独立服务层组件

### Technical Stack Integration
**基于Story 3.1基础**: 利用已建立的Playwright自动化能力和MVVM架构
**PySide6集成**: Phase 2的对话框组件使用现有GUI技术栈
**多语言支持**: 使用统一的tr()函数和TranslationManager

### File Structure Plan
```
src/services/captcha_service.py     # 验证码检测和处理服务
src/models/captcha.py               # 验证码数据模型 (Phase 2)
src/captcha_dialog.py               # 验证码输入对话框 (Phase 2)
src/exceptions.py                   # 扩展验证码相关异常类
tests/unit/test_captcha_service.py  # 单元测试
tests/integration/test_captcha.py   # 集成测试
```

### Risk Mitigation Strategy
**Phase 1优先**: 确保核心价值快速交付，降低项目风险
**向后兼容**: Phase 1实现为Phase 2打好基础，无需重构
**渐进增强**: 用户可以选择停在Phase 1或继续升级到Phase 2

### Performance Considerations
**轮询优化**: 使用QTimer确保不阻塞主线程
**内存管理**: Phase 2图片处理需要及时释放内存资源
**并发处理**: 考虑多账户处理时的验证码队列管理

## Testing

### Phase 1 Testing Strategy
**单元测试**:
- CaptchaService基础检测逻辑
- 轮询机制和超时处理
- AccountStatus状态转换

**集成测试**:
- AutomationService集成
- MVVM信号槽通信
- 完整注册流程

### Phase 2 Testing Strategy
**GUI测试**:
- CaptchaDialog界面交互
- 用户输入处理
- 多语言界面切换

**端到端测试**:
- 完整验证码处理流程
- 各种验证码类型支持
- 异常场景处理

### Test Data Strategy
- Mock验证码图片用于单元测试
- 使用`src/account_generator.py`生成测试账户
- 模拟各种验证码出现场景

## Success Metrics

### Phase 1 成功指标
- ✅ 验证码导致的注册失败率降为0%
- ✅ 用户等待时间平均减少80%
- ✅ 系统响应性保持良好（无UI阻塞）

### Phase 2 成功指标
- ✅ 验证码处理成功率达到90%+
- ✅ 用户验证码输入完成率达到95%+
- ✅ 验证码处理时间平均减少60%

## User Experience Flow

### Phase 1 用户体验流程
```
1. 用户开始批量注册
2. 系统检测到验证码 → 状态显示"验证码等待中"
3. 用户在浏览器中手动处理验证码
4. 系统自动检测到验证码消失 → 继续注册流程
5. 完成注册 → 处理下一个账户
```

### Phase 2 用户体验流程
```
1. 用户开始批量注册  
2. 系统检测到验证码 → 弹出验证码对话框
3. 用户查看验证码图片 → 输入答案 → 点击确认
4. 系统提交答案 → 继续注册流程
5. 完成注册 → 处理下一个账户
```

## Migration Strategy

从现有系统到Phase 1:
- **无破坏性更改**: 仅扩展现有功能，不修改已有逻辑
- **渐进集成**: 先在开发环境测试，确认稳定后部署
- **回滚准备**: 可以通过配置开关快速回滚到原始行为

从Phase 1到Phase 2:
- **增量开发**: Phase 2是纯增量功能，不影响Phase 1
- **用户选择**: 用户可以选择使用基础等待模式或增强协助模式
- **配置灵活**: 支持通过配置文件或用户设置调整行为

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-01 | 1.0 | 合并原Story 3.2和3.3，重新设计为分阶段实现的统一验证码系统 | Product Manager John |

## Story Merger Record

### 合并操作详情
- **原Story 3.2**: `captcha-detection-handling.md` - 全功能验证码处理系统（已删除）
- **原Story 3.3**: `captcha-detection-user-story.md` - 简单验证码等待机制（已删除）  
- **合并结果**: `3.2.captcha-smart-detection-system.md` - 分阶段智能验证码系统

### 合并理由
1. **避免功能重叠**: 两个故事都处理验证码检测，合并避免重复开发
2. **风险控制优化**: 分阶段实现策略平衡了快速交付和功能完整性
3. **用户价值最大化**: Phase 1提供核心价值，Phase 2提升用户体验
4. **开发效率提升**: 统一技术架构，减少维护成本

## Dev Agent Record

### Merger Rationale
合并Story 3.2（全功能验证码处理）和Story 3.3（简单等待机制）的原因：

1. **用户价值优化**: Story 3.3提供快速价值交付，Story 3.2提供长期用户体验
2. **开发风险控制**: 分阶段实现降低技术风险，确保核心功能稳定
3. **资源效率最大化**: 避免重复开发，共享技术架构和代码基础
4. **产品路线图清晰**: Phase 1作为MVP，Phase 2作为增强功能

### Technical Decision Summary
- **统一服务架构**: 使用CaptchaService统一管理两个阶段的功能
- **MVVM架构一致性**: 两个阶段都严格遵循现有架构模式
- **向前兼容设计**: Phase 1为Phase 2提供扩展基础
- **用户体验渐进**: 从友好等待升级到主动协助

## QA Results
*待Phase 1实现后由QA代理填写*